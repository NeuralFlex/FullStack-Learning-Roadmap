name: Deploy to ECR

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: frontend
            context: ./frontend
            dockerfile: ./frontend/Dockerfile
            repository: ${{ secrets.ECR_FRONTEND_REPO }}
          - service: backend
            context: ./backend
            dockerfile: ./backend/Dockerfile
            repository: ${{ secrets.ECR_BACKEND_REPO }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS CLI
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and tag Docker image
      id: build-image
      run: |
        # Extract metadata (tags, labels) for Docker
        IMAGE_URI=${{ matrix.repository }}
        COMMIT_SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)

        # Build Docker image
        docker build -f ${{ matrix.dockerfile }} -t ${{ matrix.service }}:latest ${{ matrix.context }}

        # Tag with latest and commit SHA
        docker tag ${{ matrix.service }}:latest $IMAGE_URI:latest
        docker tag ${{ matrix.service }}:latest $IMAGE_URI:$COMMIT_SHORT_SHA

        # Output the image URI for use in other steps
        echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
        echo "commit_sha=$COMMIT_SHORT_SHA" >> $GITHUB_OUTPUT

    - name: Push Docker image to ECR
      run: |
        IMAGE_URI=${{ steps.build-image.outputs.image_uri }}
        COMMIT_SHORT_SHA=${{ steps.build-image.outputs.commit_sha }}

        # Push both tags
        docker push $IMAGE_URI:latest
        docker push $IMAGE_URI:$COMMIT_SHORT_SHA

        echo "âœ… Successfully pushed ${{ matrix.service }} image:"
        echo "  - $IMAGE_URI:latest"
        echo "  - $IMAGE_URI:$COMMIT_SHORT_SHA"

  output-uris:
    name: Output Deployed Image URIs
    runs-on: ubuntu-latest
    needs: build-and-push
    if: success()

    steps:
    - name: Generate deployment summary
      run: |
        echo "ðŸŽ‰ CI/CD Deployment Complete!"
        echo ""
        echo "ðŸ“¦ Deployed Docker Images:"
        echo ""
        echo "Frontend Repository: ${{ secrets.ECR_FRONTEND_REPO }}"
        echo "Frontend Image URI: ${{ secrets.ECR_FRONTEND_REPO }}:latest"
        echo "Frontend Image URI (SHA): ${{ secrets.ECR_FRONTEND_REPO }}:$(echo ${{ github.sha }} | cut -c1-7)"
        echo ""
        echo "Backend Repository: ${{ secrets.ECR_BACKEND_REPO }}"
        echo "Backend Image URI: ${{ secrets.ECR_BACKEND_REPO }}:latest"
        echo "Backend Image URI (SHA): ${{ secrets.ECR_BACKEND_REPO }}:$(echo ${{ github.sha }} | cut -c1-7)"
        echo ""
        echo "ðŸ“‹ Next Steps:"
        echo "Update your ECS task definitions or infrastructure manifests with these image URIs to deploy to your environment"
